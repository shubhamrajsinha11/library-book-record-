<!DOCTYPE html>
{% extends "index.html" %}
{% load static %}

{% block main_content %}
<div class="container py-4">

    <!-- Header Row -->
    <div class="row text-center mb-3">
        <div class="col-md-8">
            <h4 class="fw-bold">Books in bag ({{ bag|length }})</h4>
        </div>
        <div class="col-md-4">
            <h4 class="fw-bold">Issue Books</h4>
        </div>
    </div>

    <div class="row">
        <!-- Book List Section -->
        <div class="col-md-8">
            <div class="table-responsive rounded border p-2 shadow-sm" style="max-height: 400px;">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Thumbnail</th>
                            <th>Book Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for book in bag %}
                        <tr>
                            <td style="width: 100px;">
                                {% if book.book_thumbnail %}
                                    <img src="{{ book.book_thumbnail.url }}" alt="Thumbnail" class="img-thumbnail" style="width: 80px; height: 100px; object-fit: cover;">
                                {% else %}
                                    <img src="{% static 'sbssu_logo.jpeg' %}" alt="Default" class="img-thumbnail" style="width: 80px; height: 100px; object-fit: cover;">
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ book.book_name }}</strong><br>
                                <span>Written by: {{ book.book_author }}</span><br>
                                <small>Published by: {{ book.book_publisher }}, {{ book.book_year }}</small>
                            </td>

                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center">No book to issue!</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Checkout Form Section -->
        <div class="col-md-4">
            <div class="p-4 rounded shadow-sm" style="background-color: #f0f8ff;">
                <form action="{% url 'checkout' %}" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="ref_id_dropdown" class="form-label fw-semibold">Reference ID</label>
                        <div class="d-flex">
                            <select id="ref_id_dropdown" class="form-select me-2" name="student_ref_id">
                                <option value="">Select Reference ID</option>
                                {% for s in students %}
                                    <option value="{{ s.student_ref_id }}">{{ s.student_ref_id }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="student_name" name="student_name" readonly>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Contact</label>
                        <input type="text" class="form-control" id="student_contact" name="student_contact" readonly>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Subscriber ID</label>
                        <input type="text" class="form-control" id="student_id" name="student_id" readonly>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Start Date & Time</label>
                        <input type="datetime-local" class="form-control" name="start_date">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Return Due Date</label>
                        <input type="datetime-local" class="form-control" name="return_date">
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">Checkout</button>
                    </div>
                </form>

                <ul class="mt-3 small text-start text-muted">
                    <li>No markings or page tearing allowed.</li>
                    <li>Handle library items with care.</li>
                    <li>Books are issued for up to 2 weeks.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Student Info Autofill -->
<script>
    document.getElementById('ref_id_dropdown').addEventListener('change', function () {
        const refId = this.value;
        if (!refId) return;

        fetch(`/get_student/?ref_id=${refId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                document.getElementById('student_name').value = data.name;
                document.getElementById('student_contact').value = data.contact;
                document.getElementById('student_id').value = data.student_id;
            });
    });
</script>
{% endblock %}
